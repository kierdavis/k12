BOARD_DIR = .

EDA_DIR = ${BOARD_DIR}/../..

SCHEMATICS_DIR = ${BOARD_DIR}/schematics
BUILD_DIR = ${BOARD_DIR}/build

FOOTPRINTS_DIR = ${EDA_DIR}/footprints
TOOLS_DIR = ${EDA_DIR}/tools
BIN_DIR = ${TOOLS_DIR}/bin
PARTLIST_BIN = ${BIN_DIR}/partlist
CHECKSCHEM_BIN = ${BIN_DIR}/checkschem
ROUTE_BIN = ${BIN_DIR}/route
RENDER_BIN = ${BIN_DIR}/render

SCHEMATICS = $(shell find ${SCHEMATICS_DIR} -type f -name '*.sch')
FOOTPRINTS = $(shell find ${FOOTPRINTS_DIR} -type f -name '*.toml')

SYMPATH = ${EDA_DIR}/geda-syms

PARTLIST = ${BUILD_DIR}/parts.txt
NETLIST = ${BUILD_DIR}/netlist.net
INITIAL_LAYOUT = ${BOARD_DIR}/layout.toml
ROUTED_LAYOUT = ${BUILD_DIR}/routed.toml
INITIAL_LAYOUT_SVG = ${BUILD_DIR}/layout.svg
ROUTED_LAYOUT_SVG = ${BUILD_DIR}/routed.svg

${PARTLIST}: ${PARTLIST_BIN} ${SCHEMATICS}
	${PARTLIST_BIN} -sympath ${SYMPATH} -output ${PARTLIST} ${SCHEMATICS}

checkschem: ${CHECKSCHEM_BIN} ${SCHEMATICS}
	${CHECKSCHEM_BIN} ${SCHEMATICS}

${NETLIST}: ${SCHEMATICS}
	gnetlist -g PCB -o ${NETLIST} ${SCHEMATICS}

${ROUTED_LAYOUT}: ${INITIAL_LAYOUT} ${NETLIST} ${FOOTPRINTS}
	${ROUTE_BIN} -output ${ROUTED_LAYOUT} ${INITIAL_LAYOUT} ${NETLIST} ${FOOTPRINTS}

${INITIAL_LAYOUT_SVG}: ${INITIAL_LAYOUT} ${FOOTPRINTS}
	${RENDER_BIN} -output ${INITIAL_LAYOUT_SVG} ${INITIAL_LAYOUT} ${FOOTPRINTS}

${ROUTED_LAYOUT_SVG}: ${ROUTED_LAYOUT} ${FOOTPRINTS}
	${RENDER_BIN} -output ${ROUTED_LAYOUT_SVG} ${ROUTED_LAYOUT} ${FOOTPRINTS}
