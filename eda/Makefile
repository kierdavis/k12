BOARD_DIR = .

EDA_DIR = ${BOARD_DIR}/../..

SCHEMATICS_DIR = ${BOARD_DIR}/schematics
LAYOUT_DIR = ${BOARD_DIR}/layout

FOOTPRINTS_DIR = ${EDA_DIR}/footprints
TOOLS_DIR = ${EDA_DIR}/tools
BIN_DIR = ${TOOLS_DIR}/bin
PARTLIST_BIN = ${BIN_DIR}/partlist
CHECKSCHEM_BIN = ${BIN_DIR}/checkschem
ROUTE_BIN = ${BIN_DIR}/route
RENDER_BIN = ${BIN_DIR}/render

SCHEMATICS = $(shell find ${SCHEMATICS_DIR} -type f -name '*.sch')
FOOTPRINTS = $(shell find ${FOOTPRINTS_DIR} -type f -name '*.toml')

SYMPATH = ${EDA_DIR}/geda-syms

PARTLIST = ${BOARD_DIR}/parts.txt
NETLIST = ${LAYOUT_DIR}/netlist.net
INITIAL_LAYOUT = ${LAYOUT_DIR}/layout-initial.toml
ROUTED_LAYOUT = ${LAYOUT_DIR}/layout-routed.toml
INITIAL_LAYOUT_SVG = ${LAYOUT_DIR}/layout-initial.svg
ROUTED_LAYOUT_SVG = ${LAYOUT_DIR}/layout-routed.svg

${PARTLIST}: ${PARTLIST_BIN} ${SCHEMATICS}
	${PARTLIST_BIN} -sympath ${SYMPATH} -output ${PARTLIST} ${SCHEMATICS}

checkschem: ${CHECKSCHEM_BIN} ${SCHEMATICS}
	${CHECKSCHEM_BIN} ${SCHEMATICS}

${NETLIST}: ${SCHEMATICS}
	gnetlist -g PCB -o ${NETLIST} ${SCHEMATICS}

${ROUTED_LAYOUT}: ${INITIAL_LAYOUT} ${NETLIST} ${FOOTPRINTS}
	${ROUTE_BIN} -output ${ROUTED_LAYOUT} ${INITIAL_LAYOUT} ${NETLIST} ${FOOTPRINTS}

${INITIAL_LAYOUT_SVG}: ${INITIAL_LAYOUT} ${FOOTPRINTS}
	${RENDER_BIN} -output ${INITIAL_LAYOUT_SVG} ${INITIAL_LAYOUT} ${FOOTPRINTS}

${ROUTED_LAYOUT_SVG}: ${ROUTED_LAYOUT} ${FOOTPRINTS}
	${RENDER_BIN} -output ${ROUTED_LAYOUT_SVG} ${ROUTED_LAYOUT} ${FOOTPRINTS}
